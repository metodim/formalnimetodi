\section{Minimization and comparison of labeled transition systems}
\label{sec:bisimulation}

Bisimulation equivalence (bisimilarity) \cite{Park} is a binary relation between labeled transition systems which associates systems that can simulate each other's behaviour in a stepwise manner which enables comparison of different transition systems \cite{ModelChecking}. An alternative perspective is to consider the bisimulation equivalence as a relation between states of a single labeled transition system. Using the quotient transition system under such a relation, smaller models of the labeled transition system can be obtained \cite{ModelChecking}.

The bisimulation equivalence finds its extensive application in many areas of computer science such as concurrency theory, formal verification, set theory, etc. For instance, in formal verification minimization with respect to bisimulation equivalence is used to reduce the size of the state space to be analyzed. Also, bisimulation equivalence is of particular interest in model checking, in specific to check the equivalence of an implementation of a certain system with respect to its specification model.

TMACS implements both options: reducing the size of the state space of a given labeled transition system and checking the equivalence of two labeled transition systems, using two behavioral equivalence relations: strong bisimilarity and observational equivalence (weak bisimilarity).

\subsection{Minimization of a labeled transition system modulo strong bisimilarity}
The process of reducing the size of the state space of a labeled transition system was implemented using an approach which consists of two steps:
\begin{enumerate}
\item Computing strong bisimulation equivalence (strong bisimilarity) for the labeled transition system;
\item Minimizing the labeled transition system to its canonical form using the strong bisimilarity obtained in the first step;
\end{enumerate}

The first step, computing strong bisimulation equivalence, was implemented with two different methods: the so called
naive method and a more efficient method due to Fernandez, both of which afterwards serve as minimization procedures.

The naive algorithm for computing bisimulation equivalence stems from the theory underlying 
Tarski's fixed point theorem. It is based on the fact that the strong bisimulation equivalence is 
the largest fixed point of the monotic function $F$ as defined in \cite{ReactiveSystems} given by Tarsky's fixed 
point theorem. This algorithm has time complexity of $O(mn)$ for a labeled transition system with \emph{m} transitions and \emph{n} 
states. 

Our implementation of the algorithm takes as an input a labeled transition system in aldebaran format, and generates the corresponding labelled graph as a list of nodes representing the states which use the following data structure:
\begin{itemize}
	\item $S_p=\{(a, q)\}$ - set of pairs $(a, q)$ for state $p$ where $a$ is an outgoing action for $p$ and $q$ is a state
	reachable from $p$ with the action $a$
\end{itemize}
The algorithm then computes the strong bisimulation equivalence and outputs it as pairs of bisimilar states.

The algorithm due to Fernandez exploits the idea of the relationship between strong bisimulation equivalence 
and the relational coarsest partition problem solved by Paige and Tarjan \cite{PaigeTarjan}. It represents adaptation of the 
Paige-Tarjan algorithm of complexity $O(m \log n)$ to minimize labeled transition systems modulo bisimulation 
equivalence by computing the coarsest partition problem with respect to the family of binary relations 
$\left(T_a\right)_{a\in A}$ instead of one binary relation, where $T_a=\{(p,q)|(p,a,q)\in T\}$ is a transition 
relation for action $a\in A$ and $T$ is a set of all transitions \cite{Fernandez}. It has 
$O(m \log n)$ complexity for a labeled transition system with $m$ transitions and $n$ states. 

Our implementation of Fernandez's algorithm takes a labeled transition system in Aldebaran format as an input, generates a labelled graph and 
then partitions the labeled graph into its coarsest blocks where each block represents a set of bisimilar states. Partition 
is a set of mutually exclusive blocks whose union constitutes the graph universe.

To define graph states and transitions we used the following terminology represented by suitable data structures: 
\begin{itemize}
	\item $T_a[p]=\{q\}$ - an $a$-transition from state $p$ to state $q$
	\item $T_a{}^{-1}[q]=\{p\}$ - an inverse $a$-transition from state $q$ to state $p$
	\item $T_a{}^{-1}[B]=\cup \left\{T_a{}^{-1}[q],q\in B\right\}$ - inverse transition for block $B$ and action $a$
	\item $W$ - set of sets called splitters that are being used to split the partition
	\item infoB$(a, p)$ - info map for block $B$, state $p$ and action $a$
\end{itemize}

Having computed the strong bisimulation equivalence, the next step in the reduction of the state space of the labeled transition system uses the bisimulation equivalence obtained in the first step in order to minimize the labeled graph. This reduction is implemented as follows:
\begin{enumerate}
	\item If a pair of states $(p, q)$ is bisimilar, then the two states are merged into one single state $k=p\cup q$;
	\item All incoming transitions $r \stackrel{a}{\rightarrow} p$ and $s \stackrel{a}{\rightarrow} q$ are replaced by transitions $r \stackrel{a}{\rightarrow} k$ and $s \stackrel{a}{\rightarrow} k$;
	\item All outgoing transitions $p \stackrel{a}{\rightarrow} r$ and $q \stackrel{a}{\rightarrow} s$ are replaced by transitions $k \stackrel{a}{\rightarrow} r$ and $k \stackrel{a}{\rightarrow} s$;
	\item The duplicate transitions are not taken into consideration.
\end{enumerate}
The procedure is repeated for all pairs of bisimilar states.

This process of reduction with respect to strong bisimilarity is illustrated below in Fig. \ref{fig:bisimGraph1}. The results obtained by applying both algorithms for computing strong bisimulation equivalence are given in Table \ref{table1}. These results are then used as a basis for the reduction of the graph to its minimal form: all mutually bisimilar states are merged into a single state and their transitions are updated accordingly. 

\begin{figure}[h]
	\centering
	\includegraphics[width=3.5in]{bisimGraph1}
	\caption{Example of a labeled transition system graph and its minimial form modulo strong bisimilarity. The red dashed arrows depict the mapping of the states using the computed bisimulation equivalence. States 2 and 3 are merged into state 2 in the minimal graph, and states 4,5 and 6 are merged into state 3 in the minimal graph.}
	\label{fig:bisimGraph1}
\end{figure}

\begin{table}[h]
\begin{tabular}{| l | p{10.5cm}| }
  \hline                       
  Algorithm & Bisimulation algorithm output \\ \hline
  Naive & (2, 3), (3, 2), (4, 5), 
(5, 4), (4, 6), (6, 4), (5, 6), (6, 5), (0, 0), (1, 1), (2, 2), (3, 3), (4, 4), (5, 5), (6, 6) \\ \hline
  Fernandez & \{0\}, \{1\}, \{2\}, \{3\}, \{4, 5, 6\} \\ \hline  
\end{tabular}
\\
\caption{Computing strong bisimularity for the example labeled graph from Fig.\ref{fig:bisimGraph1}}
\label{table1}
\end{table}

\subsection{Minimization of a labeled transition system modulo weak bisimilarity}
The minimization of a labeled transition system modulo observational equivalence (weak bisimilarity) is reduced to the problem of minimization modulo strong bisimilarity, using a technique called saturation. Intuitevely, saturation amounts to first precomputing the weak transition relation and then constructing a new pair of finite processes whose original transitions are replaced by the weak transitions \cite{ReactiveSystems}. Once the algorithm for saturation is run and the original labeled transition system is saturated, the computation of weak bisimilarity amounts to computing strong bisimilarity of the saturated labeled transition system.

The algorithm for saturation in our tool was implemented as follows: The set of triples ${R}$ can be partitioned in ${2n}$ sets with: 
\begin{equation*}
	\begin{array}{lcl}
 		{T_{\tau p}=\left\{\left(p,\tau,q\right)| \left(p,\tau,q\right)\in T\right\}}, \text{and}\\
    {T_{ap}=\left\{\left(p,\tau,q\right)|\ a\neq\tau\wedge\left(p,\tau,q\right)\in T\right\}}
  \end{array}
\end{equation*} 
for every ${p\in S}$.

By the definition of ${T_{\tau p}}$ and ${T_{ap}}$ it can be seen that
\begin{equation*}
 {\bigcup_{p\in S}\left(T_{\tau p}\cup T_{ap}\right)=T},
\end{equation*} 
and also, their pairwise intersection is empty. 

The family of sets ${T^{*}_{\tau p}}$ can be iteratively constructed with:
\begin{equation*}
	\begin{array}{lcl}
		{T^{0}_{\tau p}=T_{\tau p}\cup\left\{\left(p,\tau,p\right)\right\}},\\
		{T^{i}_{\tau p}=T^{i-1}_{\tau p}\cup\left\{\left(p,\tau,r\right)|\left(\exists q\in S\right)\left(p,\tau,q\right)\in T^{i-1}_{\tau p}\wedge\left(q,\tau,r\right)\in T_{\tau q}\right\}}, \text{and} \\
		{T^{*}_{\tau p}=T^{n}_{\tau p}}
	\end{array}
\end{equation*}

(Note: ${\left|T^{*}_{\tau p}\right|\leq\left|S\right|=n}$; when for some ${k<n}$, ${T^{k}_{\tau p}=T^{k+1}_{\tau p}}$, then ${T^{*}_{\tau p}=T^{k}_{\tau p}=T^{n}_{\tau p}}$)

With this step a reflexive, transitive closure is constructed:
\begin{equation*}
	{T^{*}_{\tau}=\bigcup_{p\in A}T^{*}_{\tau p}=\left\{\left(p,\tau,q\right)|p\left(\stackrel{\tau}{\rightarrow}\right)^{*}q\right\}}
\end{equation*}

\begin{figure}[!ht]
\centering
\includegraphics[width=4.5in]{saturation}
\caption{Reflexive, transitive closure of $\tau$. The original graph is depicted with red lines}
\label{fig:saturation}
\end{figure}

The next step is to construct:
\begin{equation}\label{eq:tap}
		T'_{ap}=\bigcup_{p\in A}T'_{ap}=\left\{\left(p,a,q\right)|\left(\exists q'\in S\right)\left(p,a,q'\right)\in T\wedge q'\left(\stackrel{\tau}{\rightarrow}\right)^{*}q\right\}:
\end{equation}
\begin{equation*}
	\begin{array}{lcl}
		T^{0}_{ap}=T_{ap'},\\
		T^{i}_{ap}=T^{i-1}_{ap}\cup \left\{\left(p,a,r\right)|\left(\exists q\in S\right)\left(p,a,q\right)\in T^{i-1}_{ap}\wedge \left(q,\tau,r\right)\in T^{i-1}_{\tau q}\right\} \text{and} \\
		T'_{ap}=T^{n|Act|}_{ap}
	\end{array}
\end{equation*}

(Note: $|T'_{ap}|\leq |S||Act|=n|Act|$, when for some $k<n|Act|$, $T^{k}_{ap}=T^{k+1}_{ap}$, then $T'_{ap}=T^{k}_{ap}=T^{n|Act|}_{ap}$)

For the third step, 
\begin{equation*}
	T'=\bigcup_{p\in S}\left(T^{*}_{\tau p}\cup T'_{ap}\right)
\end{equation*}
needs to be partitioned again, defined by the destination in the triple:
\begin{equation*}
	\begin{array}{lcl}
		T_{\tau q}=\left\{\left(p,\tau,q\right)|\left(p,\tau,q\right)\in T'\right\}, \text{and}\\
		T_{bq}=\left\{\left(p,a,q\right)|a\neq\tau\wedge\left(p,a,q\right)\in T'\right\}				    
	\end{array}
\end{equation*}
for every $p\in S$, and then construct:
\begin{equation*}
	\begin{array}{lcl}
		T^{0}_{bq}=T_{bq},\\
		T^{i}_{bq}=T^{i-1}_{bq}\cup\left\{\left(p',a,q\right)|\left(\exists p\in S\right)\left(p,a,q\right)\in T^{i-1}_{bq}\wedge\left(p',\tau,p\right)\in T^{*}_{\tau p}\right\} \text{and}\\
		T^{*}_{bq}=T^{n|Act|}_{bq}
	\end{array}
\end{equation*}

Finally the saturated labeled transition system is:
\begin{equation*}
	T^{*}=\bigcup_{p\in S}\left(T^{*}_{\tau p}\cup T^{*}_{bp}\right)=\left(\stackrel{\tau}{\rightarrow}\right)^{*}\cup\left\{\left(p,a,q\right)|a\neq\tau\wedge\left(\exists p',q'\in A\right) p\left(\stackrel{\tau}{\rightarrow}\right)^{*}p'\stackrel{a}{\rightarrow}q'\left(\stackrel{\tau}{\rightarrow}\right)^{*}q\right\}
\end{equation*}

\begin{figure}[!ht]
\centering
\includegraphics[width=4.5in]{saturation2}
\caption{Example saturated labeled transition system graph}
\label{fig:saturation2}
\end{figure}

Having computed the observational equivalence (weak bisimilarity) of the original labeled transition system, the process of its minimization is the same as the process for minimization modulo strong bisimilarity applied on the saturated labeled transition system.

\subsection{Comparison of two labeled transition systems modulo strong bisimilarity}
The idea for the implementation of the equivalence checking of two labeled transition systems modulo strong bisimilarity was based on the following fact: Two labelled transition systems are (strongly) bisimilar iff their initial states are bisimilar \cite{ModellingAndAnalysis}.

That means that in order to check whether two labeled transition systems are bisimilar it is enough to check whether their initial states are bisimilar. This can be done using the following approach:
\begin{enumerate}
	\item The two labeled transition systems are merged into a single transition system
	\item An algorithm for computing the strong bisimilarity is applied to the merged system
	\item A check is performed to see if the initial states belong to the same bisimulation equivalence class
\end{enumerate}

The correctness of the implementation was tested with the use of ltsconvert and ltscompare tools of mCRL2 \cite{mCRL2}.

\subsection{Comparison of two labeled transition systems modulo weak bisimilarity}
The comparison of two labeled transition systems modulo weak bisimilariy amounts to checking strong bisimilarity over the saturated labeled transition systems \cite{ReactiveSystems}. In another words, two labeled transition systems are weakly bisimilar iff their saturated labeled transition systems are strongly bisimilar. Following this fact, we implemented the comparison of two labeled transition systems modulo weak bisimilarity by applying the saturation algorithm over the original labeled graphs in order to obtain their saturated labeled graphs, after which the process of comparison of the saturated labeled transition systems modulo strong bisimilarity was applied as described above.